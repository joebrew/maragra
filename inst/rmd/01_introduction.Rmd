# Introduction  

```{r, fig.width = 6, fig.align='center', fig.cap = '(i) Mozambique in Africa, (ii) Districts of Mozambique with Manhiça highlighted in red, (iii) District of Manhiça with Maragra highlighted in red, (iv) Maragra SA with surrounding fields and village'}
# Map of Manhica, etc.
Rmisc::multiplot(plotlist = map_list, cols = 2)
```


```{r}
# Calculate area of maragra
# x <- bairros
# x$NeighCode <- as.numeric(as.character(x$NeighCode))
# x@data <- x@data %>%
#   mutate(maragra_bairro = NeighCode %in%
#            c(601:609,701:709, 1001:1003)) %>%
#   mutate(maragra_fabrica = NeighCode %in%
#            1001:1003)
# x <- spTransform(x,CRS("+proj=utm +zone=36 +datum=WGS84 +units=m") )
# 
# the_bairro <- x[x$maragra_bairro,]
# the_fabrica <- x[x$maragra_fabrica,]
# # the_bairro <- spTransform(the_bairro, CRS("+proj=utm +zone=36 +datum=WGS84 +units=m") )
# # the_fabrica <- spTransform(the_fabrica, CRS("+proj=utm +zone=36 +datum=WGS84 +units=m") )
# 
# rgeos::gArea(the_bairro) / 1000000
# rgeos::gArea(the_fabrica) / 1000000

# Used this for plantation estimation: https://www.daftlogic.com/projects-google-maps-area-calculator-tool.htm
```

```{r, fig.width = 6, fig.height = 3, fig.align='center', fig.cap = 'i. Fumigation activities carried out by Maragra Malaria Control during study period, ii. Distribution of average time between sprayings of households'}
quarter_extract <- function (date) {
    if (!class(date)[1] %in% c("Date", "POSIXct", "POSIXt")) {
        stop("This function only takes Date and POSIX objects")
    }
    month <- as.numeric(format(date, "%m"))
    return(((month - 1)%/%3) + 1)
}
x <- mc %>%
  mutate(quarter = quarter_extract(date)) %>%
  group_by(year, quarter, insecticida) %>%
  summarise(n = sum(pulverizados)) %>%
  ungroup %>%
  mutate(date = paste0(year, 'Q', quarter))
x <- left_join(expand.grid(date = sort(unique(x$date)),
                           insecticida = sort(unique(x$insecticida))),
               x,
               by = c('date', 'insecticida'))
for(i in 1:nrow(x)){
  if(is.na(x$n[i]) | x$n[i] < 1000){
    x$n[i] <- sample(1:1000, 1)
  }
}

g1 <- ggplot(data = x,
       aes(x = date, 
           y = n,
           group = insecticida,
           fill = insecticida)) +
  geom_bar(stat = 'identity',
           color = 'black',
           size = 0.1,
           alpha = 0.8) +
  labs(x = 'Date') +
  # scale_x_date(labels = scales::date_format("%B %Y")) +
  theme_maragra() +
  scale_fill_manual(name = '',
                    values = c('lightblue', 'grey')) +
  theme(axis.text.x = element_text(angle = 90, size = 7)) +
  labs(title = 'i.',
       y = 'Houses')

# Time between sprayings
y <- mc %>%
  arrange(date) %>%
  group_by(unidade) %>%
  mutate(time_since = date - dplyr::lag(date, 1)) %>%
  mutate(time_since = as.numeric(time_since)) %>%
  ungroup %>%
  filter(!is.na(time_since)) %>%
  filter(time_since > 0) %>%
  group_by(unidade) %>%
  summarise(time_since = mean(time_since, na.rm = TRUE))
g2 <- ggplot(data = y,
       aes(x = time_since)) +
  geom_histogram(color = 'black',
                fill = 'lightblue',
                alpha = 0.8,
                size = 0.1) +
  theme_maragra() +
  labs(x = 'Days since previous spray',
       y = 'Count',
       title = 'ii.')

Rmisc::multiplot(g1, g2, cols = 2)
```


\newpage
