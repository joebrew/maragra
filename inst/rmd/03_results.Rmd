
# Results



## Descriptive statistics

```{r}
# Calculate number of workers
n <- length(unique(ab_panel$oracle_number[ab_panel$date >= '2012-01-01' & ab_panel$date <= '2016-12-31']))
```

We collected absenteeism and demographic data data on `r n` workers from 2012 through 2016. Workers were approximately 60% male, and more than 80% fieldworkers (predominantly cane-cutters). Most were in their 20s and 30s and employed on temporary contracts. Table 1 shows overall worker details divided by "Treatment" versus "Control" status. "Treatment" is considered the time beginning at IRS administration and ending one year later; "Control" is considered time observed either prior to IRS administration (and greater than 1 year after previous IRS administration) or among workers who never received IRS. Because of the temporal nature of these categories, many workers belong to both treatment and control groups, albeit at different times.

```{r, results='asis'}
# x <- ab_panel %>%
#   left_join(workers %>%
#               dplyr::select(oracle_number, date_of_birth, permanent_or_temporary, sex))
x <- model_data
x$age <- round(as.numeric(as.Date('2014-01-01') - x$date_of_birth) / 365.25, digits = -1)
x$status <- x$permanent_or_temporary


calculate <- function(var= 'sex',
                      data){
  out <- 
    data %>%
    group_by_(var) %>%
    summarise(`Treatment workers` = length(unique(oracle_number[!days_since %in% c('Never', 'Before')])),
              `Treatment days` = length(oracle_number[!days_since %in% c('Never', 'Before')]),
              `Control workers` = length(unique(oracle_number[days_since %in% c('Never', 'Before')])),
              `Control days` = length(oracle_number[days_since %in% c('Never', 'Before')])) %>%
    ungroup() %>%
    # mutate(p = round(n / sum(n) * 100, digits = 2)) %>%
    mutate(variable = '') 
    names(out)[1] <- ' '
    out$variable[1] <- Hmisc::capitalize(var)
    
    out <- out %>% dplyr::select(variable, ` `, `Treatment workers`, `Treatment days`, `Control workers`, `Control days`)
    out$` ` <- as.character(out$` `)
  return(out)
}
out_list <- list()
vars <- c('department', 
           'sex',
           'status',
           'age')
for(i in 1:length(vars)){
  message(i)
  y <- calculate(var = vars[i], data = x)
  out_list[[i]] <- y
}
demo_table <- bind_rows(out_list)
names(demo_table)[1:2] <- c('Variable', ' ')
print(xtable::xtable(demo_table,
                     caption = 'Overall worker characteristics',
                     align = c('r', 'r', rep('l', 5))),
      include.rownames = FALSE)

```

Temporary workers tended to be younger and male; female temporary workers being on average 5-10 years older than their male counterparts. Permanent workers had a bi-modal age distribution, the older peak explained by the greater density of males in administrative roles. Females accounted for 43% of temporary workers but only 16% of permanent workers (figure x).

```{r, fig.width = 5, fig.height = 3.5, fig.align='center', fig.cap = 'Age distribution by sex and worker status'}
x$age <- round(as.numeric(as.Date('2014-01-01') - x$date_of_birth) / 365.25, digits = 2)
g1 <- ggplot(data = x,
       aes(x = age,
           group = sex,
           fill = sex)) +
  geom_density(alpha = 0.8, n = 2^4) +
  facet_wrap(~permanent_or_temporary) +
  theme_maragra() +
  labs(x = 'Age',
       y = 'Density') +
  scale_fill_manual(name = 'Sex',
                    values = c('lightblue', 'grey'))
g1
```

During the study period, weather followed typical seasonal trends for the area, albeit slightly drier than previous periods.

```{r, fig.width = 6, fig.height = 3.5, fig.align='center', fig.cap = 'i. Monthly total precipitation in the Maniça district; ii. Average monthly temperature (bars) during the study period, as well as monthly maximum (red) and minimum (blue) temperatures'}
x <- weather %>%
  mutate(month = format(date, '%m')) %>%
  mutate(year = format(date, '%Y')) %>%
  mutate(date = as.Date(paste0(year, '-', month, '-01'))) %>%
  group_by(date) %>%
  summarise(precipitation = sum(precipitation, na.rm = TRUE),
            temp_max = max(temp_max, na.rm = TRUE),
            temp_min = min(temp_min, na.rm = TRUE),
            temp = mean(temp))
# x <- gather(x, key, value,precipitation:temp)

g1 <- ggplot(data = x,
       aes(x = date,
           y = precipitation)) +
  geom_bar(stat = 'identity',
           fill = 'lightblue',
           size = 0.1) +
  theme_maragra() +
  theme(axis.text.x = element_text(angle = 0)) +
  labs(x = 'Quarter',
       y = 'Milimeters') +
  scale_x_date(labels = scales::date_format("%Y"))

g2 <- ggplot(data = x,
            aes(x = date,
                y = temp)) +
  geom_bar(stat = 'identity', fill = 'grey', size = 0.1) +
  geom_line(aes(y = temp_max),
             color = 'darkred', 
             alpha = 0.5) +
  geom_line(aes(y = temp_min),
             color = 'blue', 
             alpha = 0.5) +
  # geom_linerange(aes(ymin = temp_min,
  #                    ymax = temp_max),
  #                alpha = 0.6,
  #                color = 'blue') +
   theme_maragra() +
  theme(axis.text.x = element_text(angle = 0)) +
  labs(x = 'Quarter',
       y = 'Degrees (Celcius)') +
  scale_x_date(labels = scales::date_format("%Y"))
Rmisc::multiplot(g1, g2, cols = 2)
```


In Southern Mozambique, malaria peaks during the summer months (December through March) most years (Figure 5, panel A), and worker absenteeism at Maragra rates track malaria incidence closely, following the same seasonal patterns (figure 4, panel B). Both all-cause absenteeism and sick absenteeism have declined in recent years at Maragra (figure 5, panel C), with the latter declining at a faster rate than the former. The fact that the rate of confirmed cases at the company clinic is largely non-seasonal (figure 5, panels E and F) suggests that a significant portion of workers either seek care for malaria elsewhere (for example, government health posts, of which several are nearby and in some many cases closer to workers' residence than the company clinic) or do not seek care during malaria infection. Accordingly, we focus our analysis on all-cause absenteeism rather than sickness absenteeism or malaria diagnostics, with the assumption that much of illness is captured by absenteeism but not by the clinical data.



```{r, fig.cap = 'Clinical malaria (district of Manhiça), all-cause absenteeism among Maragra workers, sick absenteeism among Maragra workers, positive cases at company clinic, and test positivity rate at company clinic', fig.height=5, fig.width=8}
# BES incidence
g1 <- 
  ggplot(data = bes %>%
           mutate(season = ifelse(p >= median(p), 'High season',
                                  'Low season')) %>%
           filter(weekdays(date) == 'Monday'),
       aes(x = date,
           y = p)) +
  geom_point(alpha = 0.6,
             aes(color = season),
             size = 0.2) +
  geom_line(alpha = 0.1) +
  theme_maragra(base_size = 9) +
  labs(x = 'Date',
       y = 'Incidence',
       title = 'A: Annualized district clinical\nmalaria incidence per 1,000') +
  scale_color_manual(name = '',
                     values = c('red', 'black')) + 
  guides(color = guide_legend(ncol = 1)) +
  theme(legend.position = c(.8, .8),
        legend.text = element_text(size = 5),
        legend.background = element_rect(fill=alpha('white', 0)))

# Absenteeism rate
g2_data <- ab_panel %>%
  group_by(month = as.Date(paste0(format(date, '%Y-%m'), '-01'))) %>%
  summarise(absences = length(which(absent)),
            absences_sick = length(which(absent_sick)),
            
            eligibles = n()) %>%
  ungroup %>%
  mutate(absenteeism_rate = absences / eligibles * 100,
         sick_absenteeism_rate = absences_sick / eligibles * 100)

g2 <- ggplot(data = g2_data,
             aes(x = month,
                 y = absenteeism_rate)) +
  geom_line(alpha = 0.6) +
  theme_maragra(base_size = 9) +
  labs(x = 'Date',
       y = 'Absenteeism rate',
       title = 'B: Monthly absenteeism rate')

g3 <- ggplot(data = g2_data,
             aes(x = month,
                 y = sick_absenteeism_rate)) +
  geom_line(alpha = 0.6) +
  theme_maragra(base_size = 9) +
  labs(x = 'Date',
       y = 'Absenteeism rate',
       title = 'C: Monthly sick absenteeism rate') 

# Weather
g4 <-
  ggplot(data = weather %>%
           group_by(date = as.Date(paste0(format(date, '%Y-%m'), '-01'))) %>%
           summarise(precipitation = sum(precipitation, na.rm = TRUE)),
         aes(x = date,
             y = precipitation)) +
  geom_line(alpha = 0.6) +
  theme_maragra(base_size = 9) +
  labs(x = 'Date',
       y = 'Mililiters',
       title = 'D: Monthly precipitation') 

# Clinical incidence of malaria
g5 <- clinic_agg %>%
  filter(date >= '2013-01-01', date <= '2016-12-31') %>%
  # mutate(date = as.Date(paste0(year, '-', month, '-01'))) %>%
  group_by(date) %>%
  summarise(tested = sum(tested),
            positive = sum(positive)) %>%
  ungroup %>%
  mutate(percent_positive = positive / tested * 100) %>%
  ggplot(aes(x = date,
             y = positive)) +
  geom_line(alpha = 0.6) +
  theme_maragra(base_size = 9) +
  labs(x = 'Date',
       y = 'Cases',
       title = 'D: Monthly malaria cases\nat company clinic') 

g6 <- clinic_agg %>%
  filter(date >= '2013-01-01', date <= '2016-12-31') %>%
  # mutate(date = as.Date(paste0(year, '-', month, '-01'))) %>%
  group_by(date) %>%
  summarise(tested = sum(tested),
            positive = sum(positive)) %>%
  ungroup %>%
  mutate(percent_positive = positive / tested * 100) %>%
  ggplot(aes(x = date,
             y = percent_positive)) +
  geom_line(alpha = 0.6) +
  theme_maragra(base_size = 9) +
  labs(x = 'Date',
       y = 'Cases',
       title = 'E: Monthly malaria test positivity rate\nat company clinic') 
Rmisc::multiplot(g1, g2, g3,
                 # g4, 
                 g5, g6, layout = matrix(c(1, 1, 2, 3, 4, 5), nrow=2, byrow=TRUE)) 
```


```{r}
fumigations <- mc %>%
  filter(date >= '2013-01-01',
         date <= '2016-12-31')
n_fumigations <- nrow(fumigations)
n_buildings <- sum(fumigations$casas_cobertas, na.rm = TRUE)
unique_agregados <- length(unique(fumigations$unidade))
people_sprayed <- length(unique(model_data$oracle_number[model_data$days_since != 'Never']))
people_observed <- length(unique(model_data$oracle_number))
pr <- function(x){prettyNum(x, big.mark = ',')}
```

**Fumigations**: During the period from January 1st, 2013 through December 31st, 2016, the Maragra Malaria Control Unit carried out `r pr(n_fumigations)` episodes of fumigation of residential "agregados" (household combinations), for a total of `r pr(n_buildings)` building-fumigation combinations. The total number of unique agregados sprayed during this period was `r pr(unique_agregados)`. Among the `r pr(people_observed)` workers for whom we have reliable absenteeism and residential data, `r pr(people_sprayed)` had their homes fumigated at least once (the majority of workers live off of the facility).

```{r}
dry_days <- length(which(weather$precipitation > 0))
n_days <- length(weather$precipitation)
p_dry <- round(dry_days / n_days * 100)
amount_rain <- round(mean(weather$precipitation[weather$precipitation > 0], na.rm = T), digits = 2)
x <- weather %>%
  group_by(month = format(date, '%m')) %>%
  summarise(precipitation = mean(precipitation, na.rm = TRUE))
```



**Absences**: We observed `r pr(nrow(ab_panel))` unique worker-days among the `r pr(people_observed)` workers. The all-period average absenteeism rate was `r round(100 * sum(ab_panel$absent) / nrow(ab_panel), digits = 2)`%, though this rate varied widely as a function of worker department, sex, residence, and season (table 1).


```{r, results='asis'}
calculate <- function(var){
  out <- 
  model_data %>%
    mutate(year = format(date, '%Y')) %>%
    mutate(on_site = ifelse(on_site,
                                    'On site',
                                    'Off site'),
           rainy = ifelse(rainy,
                          'Rainy',
                          'Dry')) %>%
    filter(!is.na(rainy)) %>%
  group_by_(var, 'year') %>%
  summarise(absences = length(which(absent)),
            eligibles = length(absent),
            workers = length(unique(oracle_number))) %>%
  ungroup %>%
  mutate(absenteeism_rate = absences / eligibles * 100) 
  names(out)[1] <- 'variable'
  out$val <- paste0(round(out$absenteeism_rate, digits = 1),
                    '%')#,
                    # ')',
                    # '\n',
                    # ' (workers:', out$workers,
                    # ')')
  out <- 
    out %>%
    dplyr::select(variable, year, val)
  
  out <- out %>%
    spread(key = year,
           value = val)
  out$variable <- as.character(out$variable)
  new_var <- ifelse(var == 'on_site',
                    'Residence',
                    ifelse(var == 'rainy',
                           'Precipitation',
                           var))
  left <- data.frame(x = c(new_var, rep('', (nrow(out) - 1))))
  out <- cbind(left, out)
  names(out)[1:2] <- c('Variable', 'x')
  # out$variable[1] <- paste0(Hmisc::capitalize(new_var), ': ', out$variable[1])
  return(out)
}
out_list <- list()
vars <- c('season', 
           'field',
          'permanent_or_temporary',
           'sex',
           'on_site',
           'rainy')
for(i in 1:length(vars)){
  x <- calculate(var = vars[i])
  out_list[[i]] <- x
}
ab_table <- bind_rows(out_list)
ab_table$Variable <- Hmisc::capitalize(ab_table$Variable)
ab_table$Variable[ab_table$Variable == 'Season'] <- 'Malaria season'
ab_table$Variable[ab_table$Variable == 'Field'] <- 'Worker type'
ab_table$Variable[ab_table$Variable == 'Permanent_or_temporary'] <- 'Contract'
ab_table$x <- Hmisc::capitalize(ab_table$x)
names(ab_table)[2] <- ''
print(xtable::xtable(ab_table,
                     caption = 'Absenteeism rate by year and worker characteristics',
                     align = c('r', 'r', 'l', rep('l', 4))),
      include.rownames = FALSE)
```


```{r}
ov_ab <- round(100 * mean(ab_panel$absent[between(ab_panel$date, as.Date('2012-01-01'), as.Date('2016-12-31'))]), digits = 2)

ov_cl <- length(which(between(clinic$date, as.Date('2012-01-01'), as.Date('2016-12-31'))))
```

**Precipitation**: Of the `r n_days` days observed, `r dry_days` had no rainfall at all (ie, approximately two-thirds). On days for which there was any rainfall at all, the average amount was approximately `r amount_rain` centimeters. Rain was most common in December and January (average of 5-5.5 cm daily) and least common in August and September (average of 0.5 cm daily). Days with any rainfall saw more absenteeism than days with no rainfall (Figure 6, panel A) and among days with any rainfall, more precipitation was associated with greater absenteeism (Figure 6, panel B) (correlation coefficient of 0.25).

```{r, fig.cap = 'Rainfall and absenteeism: association of any rainfall with absenteeism rate (left) and association of rainfall amount and absenteeism (right)', fig.height=3.5, fig.width=7, fig.align='center'}
bi_data <- model_data %>%
  group_by(date) %>%
  mutate(any_rain = mean(precipitation, na.rm = TRUE) > 0) %>%
  ungroup %>%
  filter(!is.na(any_rain)) %>%
  mutate(any_rain = ifelse(any_rain, 'Some rain', 'No rain')) %>%
  group_by(any_rain, date) %>%
  summarise(absenteeism = mean(absent) * 100)
bi_data_simple <- bi_data %>%
  group_by(any_rain) %>%
  summarise(absenteeism = mean(absenteeism))
p1 <- ggplot(data = bi_data,
       aes(x = any_rain,
           y = absenteeism)) +
  geom_jitter(alpha = 0.3, size = 0.5) +
  geom_violin(alpha = 0.4, fill = 'lightblue') +
  scale_y_log10() +
  theme_maragra() +
  geom_bar(data = bi_data_simple,
             aes(x = any_rain,
                 y = absenteeism),
             stat = 'identity',
             fill = 'grey',
             alpha = 0.8,
           width = 0.2) +
  geom_label(data = bi_data_simple,
             aes(x = any_rain,
                 y = absenteeism,
                 label = round(absenteeism, digits = 2)),
             color = 'red') +
  labs(x = '',
       y = 'Absenteeism rate (log scale)',
       title = 'A')

plot_data <- model_data %>%
  group_by(date) %>%
  summarise(precipitation = mean(precipitation, na.rm = TRUE),
            absenteeism = mean(absent)) %>%
  ungroup %>%
  filter(precipitation > 0.1)
p2 <- ggplot(data = plot_data,
       aes(x = precipitation,
           y = absenteeism * 100)) +
  geom_point(alpha = 0.3, size = 0.5) +
  scale_x_log10() +
  geom_smooth() +
  # scale_y_log10() +
  theme_maragra() +
  labs(x = 'Daily precipitation (log scale)',
       y = 'Absenteeism rate', 
       title = 'B')
Rmisc::multiplot(p1, p2, cols = 2)
```

The extent to which rainfall's effect on absenteeism is confounded by its effect on malaria is discussed in the model results section.


**Effect of IRS on clinical malaria**: The number of malaria cases registered at the company clinic during that time was 1873, for an approximate annualized clinical incidence of 110 cases per 1,000. \todo{Not done yet. In fact, not even sure if I should do this section at all, since it's basically just a distraction.}



**Costs of program**: The malaria control program at Maragra has an annual operating budget of approximately $112,000, which includes the purchase of insecticide, the wages of IRS sprayers and drivers, transportation, record-keeping, and general administrative costs. Assuming linearity in costs, the program spends approximately $19 per building sprayed. With each agregado containing an average of 2.2 workers. Much of the benefit of IRS goes to non-worker residents of sprayed agregados (who constitute a majority), but this benefit is purposefully ignored for this analysis. 


**Cost of malaria**: Given the likelihood that clinical data does not fully capture all malaria cases (and most likely captures only a small fraction of actual infections, given the high rates of acumulated adult immunity [Mayor2007]), we do not quantify the costs of malaria infection to the company. Rather, we first estimate the reduction in absenteeism attributible to IRS, and then quantify the savings associated with prevented absences. Additionally, we calculate the clinical savings of IRS by first estimating the share of absences which are associated with an episode of clinical malaria, and then applying the clinical cost per case to the equivalent share of prevented absences. We intentionally ignore the savings accrued by the public health system, as well as the likely utility gains in secondary realms such as school absenteeism, producitivity, etc. 


## Analysis

### Effect of IRS on absenteeism

Immediately following IRS, a worker's likelihood of absence drops significantly (appendix figure, panel A). As one would expect if the mechanism by which IRS reduces absence is through reduced malaria infection, the effect of IRS during the low transmission season is significant, but far less substantial in effect size (appendix figure, panel B).

In order to assess the effect of IRS on absenteeism, we created 4 worker fixed effects models for the 4 principal worker types (permanent field worker, temporary field worker, permanent non-field worker, temporary non-field worker) for both outcoms (all cause absenteeism vs. sickness absenteeism). The reason for segregating models rather than incorporating worker type as a fixed effect was that it seemed plausible that the effect of the treatment (IRS) on the outcome would be different (and vary differently over time) depending on these worker types. For instance, it is reasonable to assume that IRS' effect would be differential for a temporary worker (who likely lives in the fumigated house less than 100% of the year) than for a permanent worker. 

Given that IRS is carried out on a continuous rolling basis, we used relative worker time (as opposed to calendar) as the time component of our model - that is, each workers' days until and since IRS were standardized so that day 0 (date of fumigation) was the interruption point. This has the advantage of incorporating into the model a variety of potential time-varying confounders in a quasi-randomized fashion, thereby making it unecessary to adjust for them specifically. Our model took into account workers' residential location (on or off site) - even though off site workers by definition could not be administered IRS by Maragra - so as to capture other seasonal effects from those workers. \todo{This is not very eloquent yet and needs to be improved.}



```{r}
clean_up_model <- function(x){
  # extract coefficients
  coefs <- data.frame(coef(summary(x)))
  # use normal distribution to approximate p-value
  coefs$p.z <- 2 * (1 - pnorm(abs(coefs$t.value)))
  ps <- coefs$p.z
  x = broom::tidy(x)
  for(j in 2:(ncol(x) -1)){
    x[,j] <- x[,j] * 100
  }
  x$term <- gsub('seasonhigh', 'Malaria season', x$term)    
  x$term <- gsub('seasonlow', 'Low malaria season', x$term)
  x$term <- gsub('months_since', 'Months since IRS: ', x$term)
  x$term <- gsub('department', 'Department: ', x$term)
  x$term <- gsub('precipitation', 'Precipitation (mm) ', x$term)
  x$term <- gsub('maragra_fabricaTRUE', 'Living at factory', x$term)
  x$term <- gsub('sexM', 'Male', x$term)
  x$term <- gsub('permanent_or_temporaryTemporary', 'Temp contract', x$term)
  x$term <- gsub('rainyTRUE', 'Rainy day', x$term)
  x$term <- gsub('on_siteTRUE', 'On site', x$term)
  x$term <- gsub('on_siteFALSE', 'Off site', x$term)
  x$term <- gsub('fieldNot field worker', 'Not field worker', x$term)
  names(x) <- Hmisc::capitalize(names(x))
  names(x) <- gsub('.', ' ', names(x), fixed = TRUE)
  x$`P value` <- NA
  x$`P value`[1:length(ps)] <- ps
  x <- x %>% 
    mutate(Estimate = paste0(round(Estimate, 3), ' (P',
                             ifelse(`P value` <= 0.001,
                                    '<0.001',
                                    paste0('=', round(`P value`, 3))
                                    ), ')')) %>%
    dplyr::select(Term, Estimate)
  x <- x %>% filter(!grepl('sd_', Term))
  x <- x %>% filter(!grepl('10+', Term, fixed = TRUE))
  return(x)
}

make_models_table <- function(model_list, the_caption = "Models with worker fixed effects"){
  
  out_list <- list()
  for(i in 1:length(model_list)){
    message(i)
    this_model <- names(model_list)[i]
    the_model <- model_list[[which(names(model_list) == this_model)]]
    the_model <- clean_up_model(the_model)
    names(the_model)[2] <- this_model
    out_list[[i]] <- the_model
  }

  df <- out_list[[1]]
  namer <- names(df)[2]
  names(df)[2] <- 'Estimate'
  
  for(i in 2:length(out_list)){
    temp <- out_list[[i]]
    namer[i] <- names(temp)[2]
    names(temp)[2] <- 'Estimate'
    df <- bind_rows(df, temp)
  }
  
  library(kableExtra)
  breaker <- nrow(out_list[[1]])
  lengther <- length(out_list)
  breaks <- c(0, breaker * 1:(lengther))
  k <- kable(df, format = "latex", caption = the_caption, booktabs = T) %>%
    kable_styling()
  for (i in 1:(length(breaks)-1)){
    message(i)
    k <- k %>%
      group_rows(namer[i], 
                 breaks[i] + 1,
                 breaks[i] + breaker,
                 latex_gap_space = "1.5em") 
  }
  print(k)
}
```



The model results for all cause absenteeism (table 4) suggest a significant decrease in absenteeism following the administration of IRS. The effect is ambivalent among temporary workers, whereas among permanent workers the administration of IRS decreases absenteeism betwen 2.5 and 8.4 percentage points in the 2-9 month following administration. These effects are consistent with IRS decreasing absence through the medium of malaria, since (a) the effect is not as strong in the first month (potentially during the parasite incubation phase), the effect is stronger on field workers (who are more socioeconomically the demographic at greater risk of malaria than their administrative counterparts), and the effect is ambivalent among temporary workers (since the protective effect of IRS is only a function of the amount of time that the worker spends in the fumigated house).



```{r, results = 'asis'}
make_models_table(model_list = fe_models, the_caption = "All cause absenteeism: model results")
```


The model results for sickness only absenteeism (table 5) suggest that IRS has a significant effect on permanent field workers. The effect is directionally similar among temporary fieldworkers (but does not reach the level of significance). Among non-fieldworkers, the effect of IRS is mixed.\todo{I'll probably remove this from the final version, since we're saying that the data aren't that good...}

```{r, results = 'asis'}
make_models_table(model_list = sick_models, the_caption = "Sick absenteeism only: model results")
```


### Externalities

One potential shortcoming of our analysis thus far is that a "control" worker (ie, one whose house has never been sprayed or was sprayed greater than one year ago) may actually be conferred some protection against malaria by the fumigations at his/her neighbors' houses. This positive spillover effect would theoretically go through two channels: (i) via a reduction of mosquitoes in the vicinity and (ii) via a reduction of the malaria parasite in the blood of humans in the vicinity (ie, the parasite "reservoir").

By the same token, just as being surrounded by IRS-treated homes may indirectly protect someone living in a home not treated by IRS, one might surmise that living on the periphery of the company grounds might lead to more malaria risk relative to living in the core, since homes near the periphery but outside of Maragra are less likely to be fumigated. In other words, to the extent that both positive and spillover effects are significant enough to warrant inclusion in our model, we would expect that (i) the prevalence of IRS in a worker's neighborhood should be associated with a reduction in absenteeism of the worker and (b) workers living further from the periphery of the company grounds should have lower absenteeism than workers living at the periphery. We test both of these hypotheses.

#### Neighborhood protective effect

\todo{Working on this now}

#### Core-periphery difference

\todo{Working on this now}


## Translating absences to costs

xxx\todo{Not done yet. This will be relatively straightforward arithmetic, but I want to first make sure that the models are rock solid (since all of the "translation" hinges on them).}


## Return on investment 

\todo{Not done yet. In conversation with Eduardo from MC about getting more accurate costs}

**Savings**  
 
- In percentage point terms, reduction from 13% to 8%.  
- 5 annually prevented absences per worker.   
- 8,000 workers: 40,000 prevented absences, wage of 3 USD
- TOTAL: 120,000 USD in productivity-only savings.   

**Costs**  

- 8 IRS workers, 1500 USD yearly = 12,000 USD  
- ACT + DDT: 50,000 USD 
- Facilities, vehicles, gas: 50,000 USD  
- TOTAL: 112,000 USD in IRS-only costs  

**7% ROI** (ignoring clinical costs)


\newpage

## Robustness and generalizability 

Two principal concerns call into question the results of our analysis. First, the application of IRS to a workers house may be endogenous.\todo{Is this the right term here? We're not dealing with an "unobserved" factor per se, rather we're dealing with a situation in which the cause might influence the effect, and the effect might influence the cause, ie a feedback loop.} It is reasonable to suspect that the application of IRS to households is not random, but rather that IRS was applied more frequently to houses which had already seen a malaria case. In this case, our estimated effect of IRS on absenteeism would likely be underestimated, with the post-IRS absenteeism rates actually having declined from a greater pre-IRS absenteeism rate than otherwise suggested. 

To check for this, we estimate the odds of absenteeism as a function of receiving IRS _during the 10 day period prior to receiving IRS_. If IRS application is indeed endogenous, we would expect absenteeism to be elevated during this period (since the increase in absenteeism would be theoretically responsible for the application of IRS), a situation which would require further statistical adjustment. If, on the other hand, there is no endogeneity, we would expect absenteeism in the 10 day period prior to IRS administration to be similar to other pre-IRS absenteeism (adjusting for seasonality).\todo{Should add model specification formula here.}

The below shows our robustness check for all cause absenteeism.

```{r, echo = FALSE}
ro_data <- ab_panel %>%
  left_join(irs, by = c('date', 'unidade')) %>%
  filter(days_since < 0) %>%
  mutate(pre_irs = between(days_since, -10, -1)) %>%
  # mutate(time_period = lendable::time_period_extract(date)) %>%
  # mutate(time_period = as.character(time_period)) %>%
  mutate(time_period = make_season(date = date)) %>%
  mutate(absent_sick = ifelse(is.na(absent_sick), FALSE, absent_sick)) %>%
  left_join(workers %>%
              dplyr::select(oracle_number,
                            sex,
                            department,
                            permanent_or_temporary),
            by = 'oracle_number')
# ro_data$time_period <- as.character(ro_data$time_period)


make_model <- function(formula = 'absent ~ pre_irs + time_period'){
  ro_model <- glm(as.formula(formula), 
                data = ro_data,
                family = binomial('logit'))
  coefs <- exp(coef(ro_model))
  ci <- confint(ro_model)
  ci <- exp(ci)
  out <- data.frame(Variable = names(coefs),
                    Estimate = coefs,
                    Lower = ci[,1],
                    Upper = ci[,2])
  row.names(out) <- NULL
  out$`P value` <- coef(summary(ro_model))[,4]
  out$Significant <- ifelse(out$`P value` <= 0.001, 'xxx',
                            ifelse(out$`P value` <= 0.01, 'xx',
                                   ifelse(out$`P value` <= 0.05, 'x',
                                          '')))
  out$Variable <- as.character(out$Variable)
  out$Variable <- gsub('pre_irsTRUE', '10 days prior to IRS', out$Variable)
  out$Variable <- gsub('time_period', '', out$Variable)
  return(kable(out, format = "latex") %>%
  kable_styling() %>%
    row_spec(row = which(grepl('prior', out$Variable)),background = "yellow"))
}
```

```{r, echo = FALSE, results = 'asis'}

# # BASIC FORMULA
# make_model('absent ~ pre_irs + time_period')

# # BASIC FORMULA WITH INTERACTIONS
# make_model('absent ~ pre_irs*time_period')

# # BASIC FORMULA WITH INTERACTIONS AND ADJUSTING FOR SEX
# make_model('absent ~ pre_irs*time_period + sex')
# 
# # BASIC FORMULA WITH INTERACTIONS AND ADJUSTING FOR SEX AND DEPARTMENT
# make_model('absent ~ pre_irs*time_period + sex + department')
# 
# 
# # BASIC FORMULA WITH INTERACTIONS AND ADJUSTING FOR SEX AND DEPARTMENT AND STATUS
# make_model('absent ~ pre_irs*time_period + sex + department + permanent_or_temporary')

# Adjust for seasonality and department
make_model('absent ~ pre_irs*time_period + department')
```

The below shows our robustness check for sick only absenteeism. Unlike with all cause absenteeism, during malaria season, being in the period 10 days prior to IRS is associated with statistically greater likelihood of being absent for illness. In other words, it appears that there is somewhat of a feedback loop: when a worker misses work due to illness, his/her likelihood of getting IRS doubles in the next 10 days.\todo{What to do about this???}

```{r}
make_model('absent_sick ~ pre_irs*time_period + department')
```

The second concern is that our quantification of return on investment is distorted by the fact that we treat IRS operations as essentially linear in nature, when in reality economies of scale, in-kind purchases and other factors likely make the true cost-per-spraying convex. We address this by creating three scenarios: (1) a "start-up" scenario in which we take into account all costs incurred by starting a program from scratch, (2) a "normal" scenario in which we match the assumptions with those used in this paper (ie, account for "wear-and-tear" depreciation but not vehicle purchase, etc.) and a (3) "absorbed costs" scenario which ignores all costs which are not directly incurred by the program.... xxx... \todo{Will address this with some sensitivity analysis}

\newpage